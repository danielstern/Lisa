<!doctype HTML>
<!-- Copyright 2013 danielstern.ca - feel free to examine, learn and apply -->

<html ng-app=''> 
<head>
  <title>Legend Game</title>
  <meta name="viewport" content="width=device-width; initial-scale=1.0;">
  
  <script type="text/javascript" src="//use.typekit.net/lhm5okc.js"></script>
  <script src="lib/jquery/jquery-1.10.1.min.js"></script> 
  <script src="lib/angular/angular.js"></script>
  <script src="lib/less/less-1.3.3.min.js"></script>
  <script src="lib/bootstrap/js/bootstrap.js"></script>
  <script src="lib/underscore/underscore.js"></script>

  <link rel="stylesheet" type="text/css" href="lib/bootstrap/css/bootstrap.css">
  <link rel="stylesheet" type="text/css" href="lib/bootstrap/css/bootstrap-responsive.css">

  <script src="lang/lexicon.js"></script>
    <!-- 
  -->
</head>
<div class='container' style='padding:60px;'>
  <div class="row">
    <div class='span3'>
      <h3>Lisa</h3>
      <p id='dialogue'>Hey baby.</p>
      <form id='conversation-form'>
        <input class='disabled' id='conversation-input' type='text'>
      </form>
      <button class='btn' id='saySomethingRandom'>Say Something Random</button>
    </div>
    <div class='span3'>
      <img src='../misc/lisa.jpg' width='200px' height='auto'>
    </div>
  </div>

</div>

<script>

  $('#conversation-form').submit(function(e){

    var $input = $('#conversation-input');
    var inputText = $input.val();
    $input.val('');

    $Lisa.isTalkingTo($responder);
    $Lisa.hears(inputText);

    function $responder(words) {
      $('#dialogue').html(words); 
    }

    e.preventDefault();
    return false;
  })

  $('#saySomethingRandom').click(function(){

       $('#dialogue').html($Lisa.saySomethingRandom()); 


  });


  function Lisa() {

    var Lisa = this;
    var inTheConversation = [];

    Lisa.name = 'Lisa';

    Lisa.thinks = function(thought) {

      console.log('LISA:' , thought);
    }

    Lisa.hears = function(words) {

      var reply = Lisa.brain.process(words);
      Lisa.says(reply);


    }

    Lisa.isTalkingTo = function(thing) {

      inTheConversation.push(thing);

    }

    Lisa.saySomethingRandom = function() {

      return Lisa.brain.ponder();

    }

    Lisa.says = function(words) {

      _.each(inTheConversation, function(_responder){_responder(words)})
      return words;

    }

    Lisa.brain = new Brain(Lisa);
  }

  function Brain(host) {

    var brain = this;
    this.host = host;
   //this.lexicon = localStorage.getItem('lexicon') || Lexicon;
   //console.log('lexicon?' , JSON.parse(localStorage.getItem('lexicon')) )
   //localStorage.getItem('lexicon').toString();
   this.lexicon = Lexicon;
    this.host.thinks('I have a lexicon!');
    this.host.thinks(this.lexicon);
    this.personality = personality;
    this.mood = this.personality;

    brain.process = function(words) {

      this.host.thinks('Hmm, someone said ' + words + '.');
      var $analysis = this.analyze(words);
      var response;
      this.host.thinks($analysis);

     // localStorage.setItem('lexicon', JSON.stringify(brain.lexicon));
      if ($analysis.wordCount == '1') 
      {
        response = 'What is ' + words + "?";
        console.log(brain.lexicon);
        brain.lexicon.things.push({word:words});
      }
      return response || 'Sorry, but I have no idea what that, or anything else, means right now.';

    }

    brain.analyze = function(words) {

      var analysis = {};
      var singleWords = words.split(' ');
      analysis['wordCount'] = singleWords.length;
      analysis['isQuestion'] = words.indexOf('?') != -1;
      analysis['refersToHost'] = words.indexOf(this.host.name) != -1;
      analysis['wordsRecognized'] = _.map(singleWords, function(word) { 

       // To do... are there any words in Lisa's lexicon that she can use to respond?
       })
      return analysis;

    }

    brain.ponder = function(ideas) {

      brain.seed = _.sample(this.lexicon.things);
      var response = '';
      var seed = brain.seed;
      var things = brain.lexicon.things;



      for (var i = 0; i < brain.mood.chatty; i++) {
           switch (Math.ceil(Math.random()*10))
           {
             case 1:
               response = scopeDown(brain.seed, response);
               break;
              
             case 2:
              //response = exploreAssociations(brain.seed, response);
               break;
             case 3:
             case 6:
             case 7:
             case 8:
               response = demystify(brain.seed, response);
               break;
             case 4:
               response = scopeSideways(brain.seed, response);
             case 5:
               response = scopeUp(brain.seed, response);
               break;
              default:
               break;
             }
           }


         response = scopeUp(seed, response);
  

      function demystify(seed, response)
      {
         if (!seed.is) return response;
         response += brain.speech.express.quality(seed, _.sample(seed.is));
        response += "//";
         
         return response;
      }

      function scopeUp(seed, response) 
      {
         if (!seed.extends) return response;

         response += (seed.plural || seed.word) + " " + (seed.plural ? 'are' : 'is') + " a kind of " + seed.extends;   
           response += "//";

         var scopeUpIdea = _.where(things,{word:seed.extends[0]});
         if (scopeUpIdea[0]) brain.seed = scopeUpIdea[0];
         brain.host.thinks(brain.seed);
         return response; 
      }

      function scopeDown(seed, response) 
      {
          var scopeDownIdea = _.filter(things,function(thing){
            if (!thing.extends) return false;
            if (thing.word == seed.word) return false;
            if (thing.extends[0] == seed.word) return true;
            return false;
          })
          if (!scopeDownIdea) return response;

          brain.host.thinks("I am scoping down.");  
            
         if (scopeDownIdea[0]) {
          var idea = _.sample(scopeDownIdea);
          brain.seed = idea;
          response += "One kind of " + seed.word + " " + (idea.plural ? 'are' : 'is') + " " + (idea.plural || idea.word);
          response += "//";
         }
         return response;
      }

      /*explore associations*/
      function exploreAssociations(seed, response)
      {
         if (!seed.associated) return response;
         var associatedThing = _.sample(seed.associated);
         response += (seed.plural || seed.word) + " " + (seed.plural ? 'reminds' : 'remind') + " me of " + associatedThing;
           response += "//";
         return response;
      }

      /* compare */

      /* contrast */

      /*  scope sideways */
      
      function scopeSideways(seed, response)
      {
        if (!seed.extends) return response;
        var relatedThings = _.filter(brain.lexicon.things, function(thing){
          if (!thing.extends) return false;
          if (thing.word == seed.word) return false;
          return thing.extends[0] == seed.extends[0]
        });
        if (!relatedThings) return response;
         brain.host.thinks('I am considering related things...');
        brain.host.thinks(relatedThings);
        var sidewaysIdea = _.sample(relatedThings);
        brain.host.thinks('I have a new sideways idea...');
        brain.host.thinks(sidewaysIdea);
        if (!sidewaysIdea) return response;
            response += (seed.plural || seed.word) + " " + (seed.plural ? 'reminds' : 'remind') + " me of " + sidewaysIdea.word;
                 response += "//";
        response += sidewaysIdea.word + " is also a " + seed.extends;
           response += "//";
        brain.seed = sidewaysIdea;

        return response;

      }


      response = brain.prettify(response);
      return response;

    }

    brain.prettify = function(phrase) {
     
      phrase = _.capitalize(phrase);
      return phrase;
    }

    brain.speech = new Speech();

  }

  var personality = {

    cheerful:5,
    chatty:4,
    friendly:5,

  }

  var $Lisa = new Lisa();

  _.mixin({
     capitalize: function(string) {
      var strings = string.split('//');
      strings = _.without(strings, '');

      strings = _.map(strings, function(string){
        string = string.charAt(0).toUpperCase() + string.substring(1).toLowerCase();  
        string += ('. ');
        if (Math.random() > 0.3) string += "</p><p>"; 
        return string;
      })
      var returnString = strings.join('');
      return returnString;
   //return 'blah';
  }
});

  function Speech() {

    var speech = this;
    speech.express = new Express;

    function Express() {
      express = this;

      express.nonsense = function() {

        return "I need scissors! 67!";

      }

      express.quality = function(seed, quality) {

        var response = '';
        response += (seed.plural || seed.word) + " " + (seed.plural ? 'are' : 'is') + " " + quality;
        return response;
    }
  }


  }



</script>
